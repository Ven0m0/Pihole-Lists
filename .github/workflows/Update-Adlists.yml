name: Update Adlists
on:
  workflow_dispatch:
  #schedule:
    #- cron: "0 3 * * *"

permissions:
  contents: write
  pull-requests: write
jobs:
  update_links:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Deduplicate lines (preserve order)
        run: |
          for f in $(find . -type f -name '*.txt'); do
            LC_ALL=C awk '!seen[$0]++' "$f" > "$f.tmp" 2>/dev/null && mv "$f.tmp" "$f"
          done

      - name: Detect changes
        id: changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push branch
        if: steps.changes.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH=update-adlists-$(date +%Y%m%d%H%M)
          git checkout -b "$BRANCH"
          git commit -m "Automated dead link removal and deduplication"
          git push origin "$BRANCH"
